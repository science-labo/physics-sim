<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>物体の運動と衝突シミュレーター (3D版)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; line-height: 1.6; background-color: #f4f4f9; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .canvas-container { position: relative; height: 400px; width: 100%; margin-bottom: 20px; }
        #chartCanvas { height: 400px; width: 100%; }
        #threeDContainer { width: 100%; height: 400px; background-color: #e0e0e0; border: 1px solid #ccc; margin-bottom: 20px; }
        button { padding: 10px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        .data-list { margin-top: 20px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>

<div class="container">
    <h2>物体の運動と衝突の可視化 (3Dシミュレーション付き)</h2>
    <p>質量と速さを設定して「衝突させる」ボタンを押してください。運動エネルギーに基づく移動距離がプロットされ、3D空間で衝突がシミュレートされます。</p>

    <div class="controls">
        <div>
            <label>物体の質量 (kg): <span id="massVal">5</span></label><br>
            <input type="range" id="mass" min="1" max="20" value="5" step="1" oninput="updateLabel('mass')">
        </div>
        <div>
            <label>衝突時の速さ (m/s): <span id="speedVal">5</span></label><br>
            <input type="range" id="speed" min="1" max="20" value="5" step="1" oninput="updateLabel('speed')">
        </div>
        <button onclick="addData()">衝突させる！</button>
        <button onclick="resetData()" style="background-color: #6c757d;">データをリセット</button>
    </div>

    <h3>3D衝突シミュレーション</h3>
    <div id="threeDContainer"></div>

    <h3>データグラフ</h3>
    <div class="canvas-container">
        <canvas id="chartCanvas"></canvas>
    </div>

    <div class="data-list">
        <h3>記録データ</h3>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>回数</th>
                    <th>質量 (kg)</th>
                    <th>速さ (m/s)</th>
                    <th>速さの2乗</th>
                    <th>移動距離 (cm)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    // === グラフ関連のコード ===
    let results = [];
    const ctx = document.getElementById('chartCanvas').getContext('2d');
    let myChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: '運動エネルギー vs 移動距離',
                data: [],
                backgroundColor: 'rgba(0, 123, 255, 1)',
                pointRadius: 6
            }]
        },
        options: {
            scales: {
                x: { title: { display: true, text: '運動エネルギー (1/2 * m * v²)' } },
                y: { title: { display: true, text: '衝突した物体の移動距離 (cm)' }, beginAtZero: true }
            }
        }
    });

    function updateLabel(id) {
        document.getElementById(id + 'Val').innerText = document.getElementById(id).value;
    }

    function addData() {
        const m = parseFloat(document.getElementById('mass').value);
        const v = parseFloat(document.getElementById('speed').value);
        
        const energy = 0.5 * m * Math.pow(v, 2);
        const distance = energy * 0.5; // 係数0.5は表示用の調整 (cm)

        const newData = { x: energy, y: distance, m: m, v: v };
        results.push(newData);

        // グラフ更新
        myChart.data.datasets[0].data.push(newData);
        myChart.update();

        // テーブル更新
        updateTable(m, v, distance);

        // 3Dシミュレーションの実行
        run3DCollision(m, v, distance);
    }

    function updateTable(m, v, d) {
        const tbody = document.querySelector('#dataTable tbody');
        const row = `<tr>
            <td>${results.length}</td>
            <td>${m}</td>
            <td>${v}</td>
            <td>${v*v}</td>
            <td>${d.toFixed(2)}</td>
        </tr>`;
        tbody.innerHTML += row;
    }

    function resetData() {
        results = [];
        myChart.data.datasets[0].data = [];
        myChart.update();
        document.querySelector('#dataTable tbody').innerHTML = '';

        // 3Dシーンもリセット
        reset3DScene();
    }

    // === 3Dシミュレーション関連のコード ===
    let scene, camera, renderer;
    let movingSphere, targetCube;
    let animationId; // アニメーションループのID

    function init3D() {
        // シーンの設定
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f0f0); // 明るいグレーの背景

        // カメラの設定
        camera = new THREE.PerspectiveCamera(75, document.getElementById('threeDContainer').clientWidth / document.getElementById('threeDContainer').clientHeight, 0.1, 1000);
        camera.position.set(0, 5, 15);
        camera.lookAt(0, 0, 0);

        // レンダラーの設定
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(document.getElementById('threeDContainer').clientWidth, document.getElementById('threeDContainer').clientHeight);
        document.getElementById('threeDContainer').appendChild(renderer.domElement);

        // 光源
        const ambientLight = new THREE.AmbientLight(0x404040, 2); // 柔らかな全体光
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 10, 5).normalize();
        scene.add(directionalLight);

        // 地面
        const planeGeometry = new THREE.PlaneGeometry(50, 50);
        const planeMaterial = new THREE.MeshLambertMaterial({ color: 0x808080, side: THREE.DoubleSide });
        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
        plane.rotation.x = Math.PI / 2;
        plane.position.y = -2;
        scene.add(plane);

        // 動く物体（球）
        const sphereGeometry = new THREE.SphereGeometry(1, 32, 32);
        const sphereMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 }); // 赤
        movingSphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
        movingSphere.position.set(-10, 0, 0);
        scene.add(movingSphere);

        // 衝突される物体（立方体）
        const cubeGeometry = new THREE.BoxGeometry(2, 2, 2);
        const cubeMaterial = new THREE.MeshLambertMaterial({ color: 0x0000ff }); // 青
        targetCube = new THREE.Mesh(cubeGeometry, cubeMaterial);
        targetCube.position.set(0, 0, 0);
        scene.add(targetCube);

        // ウィンドウのリサイズイベントに対応
        window.addEventListener('resize', onWindowResize, false);

        render();
    }

    function onWindowResize() {
        camera.aspect = document.getElementById('threeDContainer').clientWidth / document.getElementById('threeDContainer').clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(document.getElementById('threeDContainer').clientWidth, document.getElementById('threeDContainer').clientHeight);
        render();
    }

    function render() {
        renderer.render(scene, camera);
    }

    function run3DCollision(mass, speed, distance) {
        // アニメーションを停止
        if (animationId) {
            cancelAnimationFrame(animationId);
        }

        // 初期位置にリセット
        movingSphere.position.set(-10, 0, 0);
        targetCube.position.set(0, 0, 0);

        // 速さを調整（見た目の速度）
        const animationSpeed = speed * 0.05; // 調整係数
        const collisionPoint = 0; // 衝突が起こるZ座標

        let startTime = null;

        function animateCollision(currentTime) {
            if (!startTime) startTime = currentTime;
            const elapsedTime = (currentTime - startTime) / 1000; // 秒単位

            // 球がターゲットに向かって移動
            movingSphere.position.x = -10 + animationSpeed * elapsedTime * 20; // 調整係数20

            // 衝突判定
            if (movingSphere.position.x >= collisionPoint - movingSphere.geometry.parameters.radius) {
                // 衝突！ターゲットを移動させる
                const displacement = distance / 50; // cmをThree.jsの単位に調整
                targetCube.position.x = displacement;

                // 爆発エフェクト（簡略版: 色の点滅）
                targetCube.material.color.set(0xffff00); // 黄色に
                setTimeout(() => {
                    targetCube.material.color.set(0x0000ff); // 元の色に戻す
                }, 200);

                // アニメーション終了
                render();
                return;
            }

            render();
            animationId = requestAnimationFrame(animateCollision);
        }
        
        animationId = requestAnimationFrame(animateCollision);
    }

    function reset3DScene() {
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
        if (movingSphere && targetCube) {
            movingSphere.position.set(-10, 0, 0);
            targetCube.position.set(0, 0, 0);
            targetCube.material.color.set(0x0000ff); // 元の色に戻す
            render();
        }
    }

    // ページロード時に3Dを初期化
    window.onload = init3D;

</script>

</body>
</html>
